<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>realtime-sync-flow.md – diagram 1/1</title>
<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    background: #ffffff;
    color: #111111;
  }
  .toolbar {
    position: sticky;
    top: 0;
    display: flex;
    gap: .5rem;
    align-items: center;
    padding: .5rem .75rem;
    border-bottom: 1px solid rgba(0,0,0,.12);
    background: rgba(0,0,0,.03);
    z-index: 10;
  }
  .toolbar input[type="range"] {
    width: 250px;
  }
  .stage-wrap {
    position: relative;
    width: 100%;
    height: calc(100vh - 52px);
    overflow: auto;
    padding: 16px;
    cursor: grab;
  }
  .stage {
    transform-origin: 0 0;
    display: inline-block;
  }
  /* make SVG selectable and crisp */
  svg {
    shape-rendering: geometricPrecision;
    text-rendering: optimizeLegibility;
  }
  .hint {
    opacity: .7;
    font-size: 12px;
    margin-left: auto;
  }
  button {
    cursor: pointer;
  }
  .panning {
    cursor: grabbing !important;
  }
</style>
</head>
<body>
  <div class="toolbar">
    <strong>realtime-sync-flow.md – diagram 1/1</strong>
    <label style="margin-left:1rem;">Zoom
      <input id="zoom" type="range" min="0.25" max="4" step="0.05" value="1.2">
    </label>
    <button id="zoomOut">-</button>
    <button id="zoomIn">+</button>
    <button id="reset">Reset</button>
    <span class="hint">Tip: Ctrl/Cmd + mouse wheel zooms · Drag to pan</span>
  </div>
  <div class="stage-wrap" id="wrap">
    <div class="stage" id="stage">
      <pre class="mermaid">
sequenceDiagram
    participant FileSystem as File System
    participant Watchdog as Watchdog Monitor
    participant EventHandler as Event Handler
    participant SyncTracker as Sync Tracker
    participant IndexingEngine as Indexing Engine
    participant ChromaDB as ChromaDB
    participant MetadataTracker as Metadata Tracker
    participant UI as User Interface

    %% Monitoring Setup
    Note over FileSystem,UI: Real-time Monitoring Initialization
    UI-&gt;&gt;SyncTracker: Start real-time sync
    SyncTracker-&gt;&gt;Watchdog: Initialize file monitoring
    Watchdog-&gt;&gt;EventHandler: Register event callbacks
    EventHandler-&gt;&gt;SyncTracker: Setup event processing
    SyncTracker--&gt;&gt;UI: Monitoring started

    %% File Change Detection
    Note over FileSystem,UI: File Change Detection Flow
    FileSystem-&gt;&gt;Watchdog: File modified event
    Watchdog-&gt;&gt;EventHandler: Process file event
    EventHandler-&gt;&gt;EventHandler: Debounce rapid changes (500ms)
    EventHandler-&gt;&gt;EventHandler: Filter system/temp files
    EventHandler-&gt;&gt;EventHandler: Validate file type &amp; size
    
    EventHandler-&gt;&gt;SyncTracker: Queue file for processing
    SyncTracker-&gt;&gt;SyncTracker: Add to change queue
    SyncTracker-&gt;&gt;MetadataTracker: Check if file actually changed
    MetadataTracker--&gt;&gt;SyncTracker: File change status
    
    alt File Actually Changed
        SyncTracker-&gt;&gt;SyncTracker: Confirm file needs reindexing
        SyncTracker-&gt;&gt;UI: Update sync status (pending)
    else File Unchanged
        SyncTracker-&gt;&gt;SyncTracker: Skip processing (no change)
    end

    %% Batch Processing
    Note over FileSystem,UI: Batch Processing Workflow
    loop Every 5 seconds or when queue reaches batch size
        SyncTracker-&gt;&gt;SyncTracker: Get next batch from queue
        SyncTracker-&gt;&gt;IndexingEngine: Process batch of changed files
        
        loop For each file in batch
            IndexingEngine-&gt;&gt;IndexingEngine: Read file content
            IndexingEngine-&gt;&gt;IndexingEngine: Extract text
            IndexingEngine-&gt;&gt;IndexingEngine: Generate chunks
            IndexingEngine-&gt;&gt;IndexingEngine: Create embeddings
            IndexingEngine-&gt;&gt;ChromaDB: Update vector storage
            ChromaDB--&gt;&gt;IndexingEngine: Confirm storage
            IndexingEngine-&gt;&gt;MetadataTracker: Update file metadata
            MetadataTracker--&gt;&gt;IndexingEngine: Metadata updated
        end
        
        IndexingEngine--&gt;&gt;SyncTracker: Batch processing complete
        SyncTracker-&gt;&gt;UI: Update sync status (processed)
    end

    %% GitHub Repository Sync
    Note over FileSystem,UI: GitHub Repository Sync Flow
    loop Every 30 minutes
        SyncTracker-&gt;&gt;SyncTracker: Check GitHub repositories
        SyncTracker-&gt;&gt;SyncTracker: Perform git pull
        
        alt Repository Updated
            SyncTracker-&gt;&gt;SyncTracker: Compare branch manifests
            SyncTracker-&gt;&gt;SyncTracker: Identify changed files
            SyncTracker-&gt;&gt;SyncTracker: Queue changed files
            SyncTracker-&gt;&gt;IndexingEngine: Process GitHub changes
            IndexingEngine--&gt;&gt;SyncTracker: GitHub sync complete
            SyncTracker-&gt;&gt;UI: Show sync notification
        else No Changes
            SyncTracker-&gt;&gt;SyncTracker: No action needed
        end
    end

    %% Error Handling
    Note over FileSystem,UI: Error Handling Flow
    alt File Processing Error
        IndexingEngine--&gt;&gt;SyncTracker: Processing error
        SyncTracker-&gt;&gt;SyncTracker: Log error details
        SyncTracker-&gt;&gt;SyncTracker: Retry with backoff
        
        alt Retry Successful
            IndexingEngine--&gt;&gt;SyncTracker: Retry succeeded
            SyncTracker-&gt;&gt;UI: Update status (success)
        else Retry Failed
            SyncTracker-&gt;&gt;SyncTracker: Move to failed queue
            SyncTracker-&gt;&gt;UI: Show error notification
        end
    else File Access Error
        Watchdog--&gt;&gt;EventHandler: File access denied
        EventHandler-&gt;&gt;SyncTracker: Skip inaccessible file
        SyncTracker-&gt;&gt;UI: Log warning (file skipped)
    else Disk Space Error
        IndexingEngine--&gt;&gt;SyncTracker: Disk space insufficient
        SyncTracker-&gt;&gt;SyncTracker: Pause sync operations
        SyncTracker-&gt;&gt;UI: Show disk space warning
    end

    %% User Interactions
    Note over FileSystem,UI: User Interaction Flow
    alt User Pauses Sync
        UI-&gt;&gt;SyncTracker: Pause real-time sync
        SyncTracker-&gt;&gt;Watchdog: Stop file monitoring
        SyncTracker-&gt;&gt;UI: Sync paused confirmation
    else User Resumes Sync
        UI-&gt;&gt;SyncTracker: Resume real-time sync
        SyncTracker-&gt;&gt;Watchdog: Restart file monitoring
        SyncTracker-&gt;&gt;UI: Sync resumed confirmation
    else User Views Sync Status
        UI-&gt;&gt;SyncTracker: Request sync status
        SyncTracker--&gt;&gt;UI: Return current status
        UI-&gt;&gt;UI: Display sync statistics
    end

    %% Manual Sync Trigger
    Note over FileSystem,UI: Manual Sync Operations
    alt User Triggers Manual Sync
        UI-&gt;&gt;SyncTracker: Force sync all files
        SyncTracker-&gt;&gt;MetadataTracker: Get all tracked files
        MetadataTracker--&gt;&gt;SyncTracker: Return file list
        SyncTracker-&gt;&gt;SyncTracker: Queue all files for check
        SyncTracker-&gt;&gt;IndexingEngine: Process full sync
        IndexingEngine--&gt;&gt;SyncTracker: Full sync complete
        SyncTracker-&gt;&gt;UI: Show completion notification
    else User Resets Sync State
        UI-&gt;&gt;SyncTracker: Reset sync state
        SyncTracker-&gt;&gt;SyncTracker: Clear all queues
        SyncTracker-&gt;&gt;MetadataTracker: Reset file states
        MetadataTracker--&gt;&gt;SyncTracker: State reset
        SyncTracker-&gt;&gt;UI: Reset confirmation
    end
      </pre>
    </div>
  </div>

  <!-- Mermaid CDN -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    const userConfig = {
      startOnLoad: true,
      theme: "default",
      themeVariables: {
        fontSize: "20px",
        lineHeight: "24px"
      }
    };
    mermaid.initialize(userConfig);

    const zoomEl = document.getElementById('zoom');
    const stage = document.getElementById('stage');
    const wrap = document.getElementById('wrap');
    const btnIn = document.getElementById('zoomIn');
    const btnOut = document.getElementById('zoomOut');
    const btnReset = document.getElementById('reset');

    let svgEl = null;
    let baseWidth = 0, baseHeight = 0;

    function applyZoom(z) {
      const scale = typeof z === 'string' ? parseFloat(z) : z;
      if (svgEl) {
        svgEl.style.transformOrigin = '0 0';
        svgEl.style.transform = `scale(${scale})`;
        if (baseWidth && baseHeight) {
          stage.style.width = Math.ceil(baseWidth * scale) + 'px';
          stage.style.height = Math.ceil(baseHeight * scale) + 'px';
        }
      } else {
        // Fallback if SVG not yet found: scale the stage
        stage.style.transformOrigin = '0 0';
        stage.style.transform = `scale(${scale})`;
      }
      zoomEl.value = scale.toFixed(2);
    }

    zoomEl.addEventListener('input', () => applyZoom(zoomEl.value));

    btnIn.addEventListener('click', () => {
      const z = Math.min(4, (parseFloat(zoomEl.value) + 0.1));
      applyZoom(z);
    });
    btnOut.addEventListener('click', () => {
      const z = Math.max(0.25, (parseFloat(zoomEl.value) - 0.1));
      applyZoom(z);
    });
    btnReset.addEventListener('click', () => applyZoom(1.2));

    // Ctrl/Cmd + wheel zoom
    wrap.addEventListener('wheel', (e) => {
      if (!(e.ctrlKey || e.metaKey)) return;
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.1 : 0.1;
      const z = Math.min(4, Math.max(0.25, parseFloat(zoomEl.value) + delta));
      applyZoom(z);
    }, {passive:false});

    // Auto-fit width on load (approx)
    window.addEventListener('load', () => {
      // Give Mermaid a moment to render
      setTimeout(() => {
        try {
          svgEl = stage.querySelector('svg');
          if (!svgEl) return;
          const bbox = svgEl.getBBox();
          baseWidth = Math.max(1, bbox.width);
          baseHeight = Math.max(1, bbox.height);
          const target = wrap.clientWidth - 32; // padding margin
          let z = target / baseWidth;
          z = Math.max(0.25, Math.min(2.5, z));
          applyZoom(z);
        } catch (e) {}
      }, 250);
    });

    // Drag to pan
    let isPanning = false;
    let startX = 0, startY = 0, startScrollLeft = 0, startScrollTop = 0;
    wrap.addEventListener('mousedown', (e) => {
      if (e.button !== 0) return; // left-click only
      isPanning = true;
      wrap.classList.add('panning');
      startX = e.pageX - wrap.offsetLeft;
      startY = e.pageY - wrap.offsetTop;
      startScrollLeft = wrap.scrollLeft;
      startScrollTop = wrap.scrollTop;
    });
    window.addEventListener('mouseup', () => {
      isPanning = false;
      wrap.classList.remove('panning');
    });
    wrap.addEventListener('mouseleave', () => {
      isPanning = false;
      wrap.classList.remove('panning');
    });
    wrap.addEventListener('mousemove', (e) => {
      if (!isPanning) return;
      e.preventDefault();
      const x = e.pageX - wrap.offsetLeft;
      const y = e.pageY - wrap.offsetTop;
      const dx = x - startX;
      const dy = y - startY;
      wrap.scrollLeft = startScrollLeft - dx;
      wrap.scrollTop = startScrollTop - dy;
    });
  </script>
</body>
</html>
